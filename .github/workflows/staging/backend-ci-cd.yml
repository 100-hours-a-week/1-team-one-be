name: Backend CI/CD

permissions:
  contents: write
  pull-requests: read

on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [dev, main]

jobs:
  build-and-test: # PR ëŒ€ìƒ: Full CI (Lint â†’ Build â†’ Test â†’ Artifact)
    # closedëŠ” ì œì™¸ (ë³‘í•© ì‹œì—ëŠ” CDë§Œ ì‹¤í–‰)
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. JDK í™˜ê²½ ì„¤ì • (ìºì‹± í¬í•¨)
      - name: Setup JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'gradle' # ì˜ì¡´ì„±: ~/.gradle/caches, ~/.gradle/wrapper ìºì‹±

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4.Gradle ë¹Œë“œ ìºì‹œ (ì„ íƒì , ë” ë¹ ë¥¸ ë¹Œë“œ)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3 # ë¹Œë“œ ìºì‹±

      # Phase 1: Lint (Checkstyle)
      #- name: Run Checkstyle
      #  run: ./gradlew checkstyleMain checkstyleTest
      #  continue-on-error: true  # ì´ˆê¸°ì—” ê²½ê³ ë§Œ (ì ì§„ì  ê°œì„ )

      # Phase 2: Build
      - name: Build with Gradle
        run: ./gradlew build -x test

      # Phase 3: Test (TODO: í…ŒìŠ¤íŠ¸ ì‘ì„± í›„ í™œì„±í™”)
      #- name: Run unit tests
      #  run: ./gradlew test

      # Phase 4: Artifact Upload
      # plane.jar ìƒì„±/ì €ì¥ ì•ˆí•˜ëŠ” ê²ƒì€ build.gradleì—ì„œ ì„¤ì •
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ github.sha }}
          path: build/libs/*.jar
          retention-days: 14
          compression-level: 0  # JARëŠ” ì´ë¯¸ ì••ì¶•ë¨

      # í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (KST)
      - name: Get Current Time
        if: always()
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: "+09:00" # í•œêµ­ ì‹œê°„
          timezone: 'Asia/Seoul'

      # Phase 5: Discord ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… BE CI ì„±ê³µ",
              "color": 5763719,
              "fields": [
                {"name": "Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "Merge To", "value": "${{ github.base_ref }}", "inline": false},
                {"name": "Triggered By", "value": "${{ github.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. <@&${{ secrets.DISCORD_ROLE_BACKEND }}>'

      # Phase 5: Discord ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ BE CI ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                {"name": "Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "Merge To", "value": "${{ github.base_ref }}", "inline": false},
                {"name": "Triggered By", "value": "${{ github.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. <@&${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}> '

  # Dev í™˜ê²½ ë°°í¬ (dev ë¸Œëœì¹˜ merge ì‹œ)
  deploy-dev:
    if: github.event.pull_request.merged == true && github.base_ref == 'dev'
    uses: ./.github/workflows/deploy-template.yml
    with:
      environment: dev
      server_host: ${{ secrets.DEV_SERVER_HOST }}
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.sha }}
      base_ref: ${{ github.base_ref }}
      pr_title: ${{ github.event.pull_request.title }}
      actor: ${{ github.actor }}
      repository: ${{ github.repository }}
      run_id: ${{ github.run_id }}
      create_tag: false
    secrets:
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_ROLE_BACKEND: ${{ secrets.DISCORD_ROLE_BACKEND }}
      DISCORD_ROLE_BACKEND_ONCALL: ${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Staging í™˜ê²½ ë°°í¬ (main ë¸Œëœì¹˜ merge ì‹œ, ìë™)
  deploy-staging:
    if: github.event.pull_request.merged == true && github.base_ref == 'main'
    uses: ./.github/workflows/deploy-template.yml
    with:
      environment: staging
      server_host: ${{ secrets.STAGING_SERVER_HOST }}
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.sha }}
      base_ref: ${{ github.base_ref }}
      pr_title: ${{ github.event.pull_request.title }}
      actor: ${{ github.actor }}
      repository: ${{ github.repository }}
      run_id: ${{ github.run_id }}
      create_tag: false
    secrets:
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_ROLE_BACKEND: ${{ secrets.DISCORD_ROLE_BACKEND }}
      DISCORD_ROLE_BACKEND_ONCALL: ${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Production í™˜ê²½ ë°°í¬ (Staging ì„±ê³µ í›„ ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”)
  deploy-production:
    if: github.event.pull_request.merged == true && github.base_ref == 'main'
    needs: [deploy-staging]
    uses: ./.github/workflows/deploy-template.yml
    with:
      environment: production  # GitHub Environmentì—ì„œ Required reviewers ì„¤ì • í•„ìˆ˜
      server_host: ${{ secrets.PROD_SERVER_HOST }}
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.sha }}
      base_ref: ${{ github.base_ref }}
      pr_title: ${{ github.event.pull_request.title }}
      actor: ${{ github.actor }}
      repository: ${{ github.repository }}
      run_id: ${{ github.run_id }}
      create_tag: true  # Productionë§Œ ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ìƒì„±
    secrets:
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_ROLE_BACKEND: ${{ secrets.DISCORD_ROLE_BACKEND }}
      DISCORD_ROLE_BACKEND_ONCALL: ${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}